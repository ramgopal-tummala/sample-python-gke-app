name: Build and Deploy to GKE

on:
  push:
    branches:
      - testbranch
  pull_request:
    branches:
      - testbranch

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_REGION: ${{ secrets.GKE_REGION }}
  IMAGE: sample-python-gke-app

jobs:
  build-push-deploy:
    name: Build, Push to GCR, and Deploy to GKE
    runs-on: ubuntu-latest
    environment: New_repo_secs
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true
      
      - name: Configure Docker for GCR
        run: |
          gcloud auth configure-docker
      
      - name: Build Docker image
        run: |
          docker build -t gcr.io/$PROJECT_ID/$IMAGE:${{ github.sha }} \
                       -t gcr.io/$PROJECT_ID/$IMAGE:latest .
      
      - name: Push to Google Container Registry
        run: |
          docker push gcr.io/$PROJECT_ID/$IMAGE:${{ github.sha }}
          docker push gcr.io/$PROJECT_ID/$IMAGE:latest
      
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER --region $GKE_REGION
      
      - name: Deploy to GKE
        run: |
          # Apply ConfigMap first
          kubectl apply -f k8s/deployment.yaml
          
          # Update the deployment with new image
          kubectl set image deployment/sample-python-app \
            sample-python-app=gcr.io/$PROJECT_ID/$IMAGE:${{ github.sha }}
          
          # Apply service and HPA
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/hpa.yaml
          
          # Wait for rollout to complete
          kubectl rollout status deployment/sample-python-app
      
      - name: Deployment Summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ“¦ Image: gcr.io/$PROJECT_ID/$IMAGE:${{ github.sha }}"
          echo "ðŸš€ Cluster: $GKE_CLUSTER ($GKE_REGION)"
          echo ""
          echo "ðŸ“Š Deployment Status:"
          kubectl get deployments
          echo ""
          echo "ðŸ”— Service Info:"
          kubectl get services sample-python-app-service
